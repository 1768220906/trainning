<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hot Github Non</title>
    <link rel="stylesheet" href="./dist/index.css" />
    <link rel="stylesheet" href="./dist/book.css" />
    <link rel="stylesheet" href="./dist/page.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
      crossorigin="anonymous"
    />
    <!-- StPageFlip -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/src/Style/stPageFlip.min.css"
    />
  </head>

  <body>
    <div id="root"></div>
  </body>

  <!-- React / ReactDOM -->
  <script
    src="https://cdn.jsdelivr.net/npm/react@18.3.0/umd/react.development.js"
    integrity="sha256-YGCi0siahOHX/Wdi87L6KJxDunX+Fx7SnUI5lprFxBY="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/react-dom@18.3.0/umd/react-dom.development.js"
    integrity="sha256-GfcKEHBZUuhqx1JMlm3JNiAT4WrlY5QUFWg40eC9mxg="
    crossorigin="anonymous"
  ></script>
  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js" crossorigin></script>
  <!-- StPageFlip -->

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 自定义代码 -->
  <script src="./dist/request.js"></script>
  <script src="./dist/service.js"></script>
  <script src="./dist/utils.js"></script>

  <!-- React Router -->
  <script type="text/babel">
    const { createContext, useContext, useState, useEffect } = React;

    const LanguageContext = createContext();

    const translations = {
      en: {
        hotGithubProjects: "Hot Github Projects",
        mainLanguage: "Language:",
        mainTopic: "MainTopic:",
        javascript: "Javascript",
        frontend: "Frontend",
        thanksForBrowsing: "Thanks for browsing!",
        about: "About",
        notFound: "404 Not Found",
        loading: "Loading...",
        prevPage: "Prev Page",
        nextPage: "Next Page",
      },
      zh: {
        hotGithubProjects: "Github 热门项目汇总",
        mainLanguage: "主要语言：",
        mainTopic: "主要话题：",
        javascript: "Javascript",
        frontend: "前端",
        thanksForBrowsing: "感谢浏览！",
        about: "关于",
        notFound: "404 未找到",
        loading: "加载中...",
        prevPage: "上一页",
        nextPage: "下一页",
      },
    };

    function LanguageProvider({ children }) {
      const [language, setLanguage] = useState(() => {
        const lang = new URLSearchParams(
          window.location.hash.split("?")[1]
        ).get("lang");
        return lang || localStorage.getItem("language") || "en";
      });

      useEffect(() => {
        localStorage.setItem("language", language);
        const [hash, query] = window.location.hash.slice(1).split("?");
        const params = new URLSearchParams(query);
        params.set("lang", language);
        window.location.hash = `${hash}?${params.toString()}`;
      }, [language]);

      const t = (key) => translations[language][key] || key;

      return (
        <LanguageContext.Provider value={{ language, setLanguage, t }}>
          {children}
        </LanguageContext.Provider>
      );
    }

    const RouterContext = createContext({ location: "/" });

    function HashRouter({ children }) {
      const [location, setLocation] = useState(
        window.location.hash.slice(1) || "/"
      );

      useEffect(() => {
        const handleHashChange = () => {
          setLocation(window.location.hash.slice(1) || "/");
        };
        window.addEventListener("hashchange", handleHashChange);
        return () => window.removeEventListener("hashchange", handleHashChange);
      }, []);

      return (
        <RouterContext.Provider value={{ location }}>
          {children}
        </RouterContext.Provider>
      );
    }

    function NavigateTo({ to }) {
      useEffect(() => {
        window.location.hash = to;
      }, [to]);

      return null; // 不渲染任何 UI
    }

    // 自定义 hook
    function useParams() {
      const { location } = useContext(RouterContext);
      const [params, setParams] = useState({});
      useEffect(() => {
        const searchParams = new URLSearchParams(location.search);
        const newParams = {};
        for (const [key, value] of searchParams.entries()) {
          newParams[key] = value;
        }
        setParams(newParams);
      }, [location.search]);

      return params;
    }

    function useNavigate() {
      return (to) => {
        window.location.hash = to;
      };
    }

    function useRoutes(routes) {
      const { location } = useContext(RouterContext);
      const path = location.split("?")[0];

      for (const route of routes) {
        if (route.path === path) {
          return route.element;
        }
      }
      // Return the wildcard route if no other route matches
      for (const route of routes) {
        if (route.path === "*") {
          return route.element;
        }
      }
      return null;
    }

    function Route({ path, element }) {
      const { location } = useContext(RouterContext);
      return location === path ? element : null;
    }

    function Link({ to, children }) {
      return <a href={`#${to}`}>{children}</a>;
    }
  </script>

  <!-- 首页 -->
  <script type="text/babel">
    function HotProjectItem(props) {
      const { item } = props;
      return (
        <div className="project-item">
          <div className="order">#{item.order}</div>
          <div className="cover">
            <img src={item.owner.avatar_url} alt={item.name} loading="lazy" />
          </div>
          <div className="title">{item.name}</div>
          <div className="description">
            <div className="info owner">
              <div className="icon">
                <i className="fa fa-user"></i>
              </div>
              <div className="text">{item.owner.login}</div>
            </div>
            <div className="info star">
              <div className="icon">
                <i className="fa fa-star"></i>
              </div>
              <div className="text">{item.stargazers_count} stars</div>
            </div>
            <div className="info fork">
              <div className="icon">
                <i className="fa fa-code-fork"></i>
              </div>
              <div className="text">{item.forks_count} forks</div>
            </div>
            <div className="info issue">
              <div className="icon">
                <i className="fa fa-exclamation-circle"></i>
              </div>
              <div className="text">{item.open_issues_count} open issues</div>
            </div>
          </div>
        </div>
      );
    }

    function BookPage(props) {
      const { items } = props;

      return (
        <div className="page">
          <div className="page-content">
            <div className="project-list">
              {items.map((item) => (
                <HotProjectItem key={item.id} item={item} />
              ))}
            </div>
          </div>
        </div>
      );
    }

    function BookCover() {
      const { language, t } = useContext(LanguageContext);
      return (
        <div className="page page-cover page-cover-top">
          <div className="cover-container">
            <div className="cover-title">{t("hotGithubProjects")}</div>
            <div className="cover-logo">
              <i className="fa fa-github"></i>
            </div>
            <div className="cover-query">
              <div className="language query-item">
                <div className={"item-label"}>{t("mainLanguage")}</div>
                <div className="item-value">{t("javascript")}</div>
              </div>

              <div className="stars query-item">
                <div className={"item-label"}>{t("mainTopic")}</div>
                <div className="item-value">{t("frontend")}</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // 封底
    function BookBottom() {
      const { t } = useContext(LanguageContext);
      return (
        <div className="page page-cover page-cover-bottom">
          <div className="cover-container">
            <div className="cover-title">{t("thanksForBrowsing")}</div>
          </div>
        </div>
      );
    }

    const defaultQuery = {
      q: "language:javascript",
      per_page: 20,
      page: 1,
    };

    function Content() {
      const { useRef, useState, useEffect, useContext } = React;
      const { t } = useContext(LanguageContext);
      const bookRef = useRef(null);

      const [pages, setPages] = useState([]);
      const [loading, setLoading] = useState(false);
      const [dataPage, setDataPage] = useState(1);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
      const [currentPage, setCurrentPage] = React.useState(1);
      const totalPageRef = useRef(2);
      const prevCurrentPageRef = useRef(1);
      const touchStartX = useRef(0);

      useEffect(() => {
        const handleResize = () => {
          setIsMobile(window.innerWidth < 768);
        };
        window.addEventListener("resize", handleResize);
        return () => window.removeEventListener("resize", handleResize);
      }, []);

      const nextPage = () => {
        const increment = isMobile ? 1 : 2;
        setCurrentPage((p) => Math.min(p + increment, totalPageRef.current));
      };

      const prevPage = () => {
        const increment = isMobile ? 1 : 2;
        setCurrentPage((p) => Math.max(p - increment, 1));
      };

      const handleTouchStart = (e) => {
        touchStartX.current = e.touches[0].clientX;
      };

      const handleTouchEnd = (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        if (touchStartX.current - touchEndX > 50) {
          nextPage();
        }
        if (touchStartX.current - touchEndX < -50) {
          prevPage();
        }
      };

      useEffect(() => {
        if (isMobile && bookRef.current) {
          bookRef.current.addEventListener("touchstart", handleTouchStart);
          bookRef.current.addEventListener("touchend", handleTouchEnd);
        }
        return () => {
          if (isMobile && bookRef.current) {
            bookRef.current.removeEventListener("touchstart", handleTouchStart);
            bookRef.current.removeEventListener("touchend", handleTouchEnd);
          }
        };
      }, [isMobile, bookRef.current]);

      const getGithubData = async (changeQuery = {}) => {
        if (loading) return { data: [], total_count: 0 };
        setLoading(true);
        try {
          const query = {
            ...defaultQuery,
            ...changeQuery,
          };
          const res = await getHotProjects(query);
          const { items, total_count } = res;
          const chunkSize = isMobile ? 2 : 10;
          const data = chunkArray(items, chunkSize, query.page);
          setLoading(false);
          return { data, total_count };
        } catch (error) {
          alert("Error fetching data from Github API");
          setLoading(false);
          return { data: [], total_count: 0 };
        }
      };

      const init = async () => {
        const { data, total_count } = await getGithubData({ page: 1 });
        setPages(data);
        if (total_count > 0) {
          const mobileDataPages = Math.ceil(total_count / 2);
          const desktopDataPages = Math.ceil(total_count / 10);
          const newTotalPage = isMobile
            ? mobileDataPages + 2
            : desktopDataPages + 2;
          console.log(newTotalPage, "newTotalPage");
          totalPageRef.current = newTotalPage;
        }
        setDataPage(2);
      };

      useEffect(() => {
        init();
      }, [isMobile]);

      useEffect(() => {
        if (
          currentPage > prevCurrentPageRef.current &&
          currentPage >= pages.length - (isMobile ? 1 : 2)
        ) {
          getGithubData({ page: dataPage }).then(({ data }) => {
            if (data && data.length > 0) {
              setPages((p) => [...p, ...data]);
              setDataPage((p) => p + 1);
            }
          });
        }
        prevCurrentPageRef.current = currentPage;
      }, [currentPage]);

      const allPages = [
        { key: "cover", type: "cover" },
        ...pages,
        { key: "bottom", type: "bottom" },
      ];

      return (
        <>
          {!isMobile && (
            <div>
              <button onClick={prevPage}>
                &larr; {t("prevPage")} &nbsp;&nbsp;&nbsp;
              </button>
              <button onClick={nextPage}>{t("nextPage")} &rarr;</button>
            </div>
          )}

          <div
            className={`book-container ${isMobile ? "mobile" : ""}`}
            ref={bookRef}
          >
            {isMobile ? (
              allPages.map((page, index) => (
                <div
                  key={page.key}
                  className={`page-container ${
                    currentPage > index + 1 ? "flipped" : ""
                  }`}
                  style={{ zIndex: allPages.length - index }}
                >
                  {page.type === "cover" && <BookCover />}
                  {page.type === "bottom" && <BookBottom />}
                  {page.type !== "cover" && page.type !== "bottom" && (
                    <BookPage items={page.data} />
                  )}
                </div>
              ))
            ) : (
              <>
                <div
                  key={"cover"}
                  className={`page-container ${
                    currentPage > 1 ? "left" : "right"
                  }`}
                  style={{ zIndex: currentPage > 1 ? 0 : pages.length + 1 }}
                >
                  <BookCover />
                </div>
                {pages.map((item, index) => (
                  <div
                    key={item.key}
                    className={`page-container ${
                      currentPage > index + 2 ? "left" : "right"
                    }`}
                    style={{
                      zIndex:
                        currentPage > index + 2
                          ? index + 1
                          : pages.length - index,
                    }}
                  >
                    <BookPage items={item.data} />
                  </div>
                ))}
                <div
                  key={"bottom"}
                  className={`page-container ${
                    currentPage === totalPageRef.current ? "left" : "right"
                  }`}
                  style={{
                    zIndex:
                      currentPage === totalPageRef.current
                        ? pages.length + 1
                        : 0,
                  }}
                >
                  <BookBottom />
                </div>
              </>
            )}
          </div>
        </>
      );
    }

    function Header() {
      const { language, setLanguage, t } = useContext(LanguageContext);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

      useEffect(() => {
        const handleResize = () => {
          setIsMobile(window.innerWidth < 768);
        };
        window.addEventListener("resize", handleResize);
        return () => window.removeEventListener("resize", handleResize);
      }, []);

      return (
        <div className="header-bg">
          {!isMobile && (
            <div>
              <select
                onChange={(e) => setLanguage(e.target.value)}
                value={language}
              >
                <option value="en">English</option>
                <option value="zh">中文</option>
              </select>
            </div>
          )}
        </div>
      );
    }

    function LanguageFAB() {
      const { language, setLanguage } = useContext(LanguageContext);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

      useEffect(() => {
        const handleResize = () => {
          setIsMobile(window.innerWidth < 768);
        };
        window.addEventListener("resize", handleResize);
        return () => window.removeEventListener("resize", handleResize);
      }, []);

      if (!isMobile) return null;

      const toggleLanguage = () => {
        setLanguage(language === "en" ? "zh" : "en");
      };

      return (
        <button className="language-fab" onClick={toggleLanguage}>
          {language === "en" ? "中" : "En"}
        </button>
      );
    }

    // 首页
    function Home() {
      return (
        <div className="home-container">
          <Header />
          <Content />
          <LanguageFAB />
        </div>
      );
    }
  </script>

  <script type="text/babel">
    function About() {
      const { t } = useContext(LanguageContext);
      return <div className="text-center text-6xl">📄 {t("about")}</div>;
    }

    function NotFound() {
      const { t } = useContext(LanguageContext);
      return <div>🚫 {t("notFound")}</div>;
    }
  </script>

  <!-- 路由配置 -->
  <script type="text/babel">
    const routes = [
      { path: "/", element: <NavigateTo to="/home" /> },
      { path: "/home", element: <Home /> },
      { path: "/about", element: <About /> },
      { path: "*", element: <NotFound /> },
    ];

    function Outlet() {
      return useRoutes(routes);
    }
  </script>

  <!-- app.js -->
  <script type="text/babel">
    function App() {
      return (
        <LanguageProvider>
          <HashRouter>
            <Outlet />
          </HashRouter>
        </LanguageProvider>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</html>
